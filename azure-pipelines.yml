trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  azureServiceConnection: 'AzureSP'   # Your Azure DevOps service connection
  tfWorkingDir: '.'                    # Terraform code folder
  backendResourceGroup: 'tfstate-rg'
  backendStorageAccount: 'tfstateaccountarati'
  backendContainer: 'tfstate'
  backendKey: 'infra.terraform.tfstate'

  # Terraform variables
  rg_name: 'rg-enterprise-app'
  location: 'canadacentral'
  location_short: 'ccan'

stages:

# ------------------- CI Stage -------------------
- stage: Validate
  displayName: 'Terraform CI: Format & Validate'
  jobs:
    - job: Terraform_Validate
      displayName: 'Terraform Format & Validate'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self

        # Install Terraform
        - task: Bash@3
          displayName: 'Install Terraform 1.3.9'
          inputs:
            targetType: 'inline'
            script: |
              curl -sSL https://releases.hashicorp.com/terraform/1.3.9/terraform_1.3.9_linux_amd64.zip -o terraform.zip
              unzip terraform.zip
              sudo mv terraform /usr/local/bin/
              terraform version

        # Clean Terraform cache
        - script: |
            rm -rf .terraform .terraform.lock.hcl
          displayName: 'Clean Terraform cache'

        # Terraform Init
        - task: TerraformCLI@1
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(tfWorkingDir)'
            backendType: 'azurerm'
            ensureBackend: true
            backendServiceArm: '$(azureServiceConnection)'
            backendAzureRmResourceGroupName: '$(backendResourceGroup)'
            backendAzureRmStorageAccountName: '$(backendStorageAccount)'
            backendAzureRmContainerName: '$(backendContainer)'
            backendAzureRmKey: '$(backendKey)'

        # Terraform Format check
        - task: TerraformCLI@1
          displayName: 'Terraform Format Check'
          inputs:
            provider: 'azurerm'
            command: 'fmt'
            workingDirectory: '$(tfWorkingDir)'
            arguments: '-check -recursive'

        # Terraform Validate
        - task: TerraformCLI@1
          displayName: 'Terraform Validate'
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(tfWorkingDir)'
            arguments: '-var "rg_name=$(rg_name)" -var "location=$(location)" -var "location_short=$(location_short)"'

# ------------------- CD Stage -------------------
- stage: Deploy
  displayName: 'Terraform CD: Plan & Apply'
  dependsOn: Validate
  condition: succeeded()
  jobs:
    - deployment: Terraform_Apply
      displayName: 'Terraform Apply'
      environment: 'dev'
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Install Terraform
              - task: Bash@3
                displayName: 'Install Terraform 1.3.9'
                inputs:
                  targetType: 'inline'
                  script: |
                    curl -sSL https://releases.hashicorp.com/terraform/1.3.9/terraform_1.3.9_linux_amd64.zip -o terraform.zip
                    unzip terraform.zip
                    sudo mv terraform /usr/local/bin/
                    terraform version

              # Clean Terraform cache
              - script: |
                  rm -rf .terraform .terraform.lock.hcl
                displayName: 'Clean Terraform cache'

              # Terraform Init
              - task: TerraformCLI@1
                displayName: 'Terraform Init'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: '$(tfWorkingDir)'
                  backendType: 'azurerm'
                  ensureBackend: true
                  backendServiceArm: '$(azureServiceConnection)'
                  backendAzureRmResourceGroupName: '$(backendResourceGroup)'
                  backendAzureRmStorageAccountName: '$(backendStorageAccount)'
                  backendAzureRmContainerName: '$(backendContainer)'
                  backendAzureRmKey: '$(backendKey)'

              # Terraform Plan
              - task: TerraformCLI@1
                displayName: 'Terraform Plan'
                inputs:
                  provider: 'azurerm'
                  command: 'plan'
                  workingDirectory: '$(tfWorkingDir)'
                  arguments: '-var "rg_name=$(rg_name)" -var "location=$(location)" -var "location_short=$(location_short)" -out=tfplan'

              # Terraform Apply
              - task: TerraformCLI@1
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: '$(tfWorkingDir)'
                  arguments: '-auto-approve tfplan -var "rg_name=$(rg_name)" -var "location=$(location)" -var "location_short=$(location_short)"'
