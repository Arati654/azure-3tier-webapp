trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  azureServiceConnection: 'AzureSP'   # Name of your Azure DevOps service connection
  tfWorkingDir: '.'                    # Path to your Terraform code
  backendResourceGroup: 'tfstate-rg'
  backendStorageAccount: 'tfstateaccountarati'
  backendContainer: 'tfstate'
  backendKey: 'infra.terraform.tfstate'

stages:

# ------------------- CI Stage -------------------
- stage: Validate
  displayName: 'Terraform CI: Format & Validate'
  jobs:
    - job: Terraform_Validate
      displayName: 'Terraform Format & Validate'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self

        # Terraform Init
        - task: TerraformCLI@1
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(tfWorkingDir)'
            backendType: 'azurerm'
            ensureBackend: true
            backendServiceArm: '$(azureServiceConnection)'
            backendAzureRmResourceGroupName: '$(backendResourceGroup)'
            backendAzureRmStorageAccountName: '$(backendStorageAccount)'
            backendAzureRmContainerName: '$(backendContainer)'
            backendAzureRmKey: '$(backendKey)'

        # Terraform Format check
        - task: TerraformCLI@1
          displayName: 'Terraform Format Check'
          inputs:
            provider: 'azurerm'
            command: 'fmt'
            workingDirectory: '$(tfWorkingDir)'
            arguments: '-check -recursive'

        # Terraform Validate
        - task: TerraformCLI@1
          displayName: 'Terraform Validate'
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(tfWorkingDir)'

# ------------------- CD Stage -------------------
- stage: Deploy
  displayName: 'Terraform CD: Apply to Azure'
  dependsOn: Validate
  condition: succeeded()
  jobs:
    - deployment: Terraform_Apply
      displayName: 'Terraform Apply'
      environment: 'dev'
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Terraform Init
              - task: TerraformCLI@1
                displayName: 'Terraform Init'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: '$(tfWorkingDir)'
                  backendType: 'azurerm'
                  ensureBackend: true
                  backendServiceArm: '$(azureServiceConnection)'
                  backendAzureRmResourceGroupName: '$(backendResourceGroup)'
                  backendAzureRmStorageAccountName: '$(backendStorageAccount)'
                  backendAzureRmContainerName: '$(backendContainer)'
                  backendAzureRmKey: '$(backendKey)'

              # Terraform Plan
              - task: TerraformCLI@1
                displayName: 'Terraform Plan'
                inputs:
                  provider: 'azurerm'
                  command: 'plan'
                  workingDirectory: '$(tfWorkingDir)'
                  environmentServiceNameAzureRM: '$(azureServiceConnection)'
                  arguments: '-out=tfplan'

              # Terraform Apply
              - task: TerraformCLI@1
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: '$(tfWorkingDir)'
                  environmentServiceNameAzureRM: '$(azureServiceConnection)'
                  arguments: '-auto-approve tfplan'
