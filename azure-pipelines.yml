trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:
# ---------------- Stage 1: Terraform Validate ----------------
- stage: Validate
  displayName: 'Terraform Validate'
  jobs:
  - job: Validate
    displayName: 'Terraform Validate'
    steps:
      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: 'latest'

      - script: |
          terraform init -input=false
          terraform validate
        displayName: 'Terraform Init & Validate'

# ---------------- Stage 2: Terraform Apply ----------------
- stage: Apply
  displayName: 'Terraform Apply'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: Apply
    displayName: 'Terraform Apply'
    steps:
      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: 'latest'

      - task: AzureCLI@2
        displayName: 'Terraform Init & Apply'
        inputs:
          azureSubscription: 'AzureSP'   # ðŸ”¹ Replace with your actual service connection name
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            terraform init -input=false
            terraform plan -out=tfplan -input=false
            terraform apply -input=false -auto-approve tfplan

# ---------------- Stage 3: Terraform Destroy ----------------
- stage: Destroy
  displayName: 'Terraform Destroy'
  dependsOn: Apply
  condition: succeeded()
  jobs:
  - job: Destroy
    displayName: 'Terraform Destroy'
    steps:
      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: 'latest'

      - task: AzureCLI@2
        displayName: 'Terraform Destroy Infrastructure'
        inputs:
          azureSubscription: 'AzureSP'   # ðŸ”¹ Replace with your actual service connection name
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            terraform init -input=false
            terraform destroy -auto-approve -input=false
